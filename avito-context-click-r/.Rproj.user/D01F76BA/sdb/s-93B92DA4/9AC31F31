{
    "contents" : "source(\"_utils.R\")\n\n### read train and test datasets ###\ndata.train <- fread(fn.in.file(train.file))\ndata.train[, ID := -(SearchID*10 + Position)]\ndata.test <- fread(fn.in.file(test.file))\ndata.all <- rbindlist(list(data.train, data.test), fill = T)\nrm(data.train, data.test)\ngc()\n\n### add Lucas cv splitting ###\ndata.all.split <- data.all.search[,list(SearchType, SearchID)]\nfn.soar.unload(data.all.search)\ninvisible(gc(T))\nsetkey(data.all.split, SearchType, SearchID)\ndata.all.split <- unique(data.all.split)\nsetkey(data.all, SearchID)\nsetkey(data.all.split, SearchID)\ndata.all <- merge(data.all, data.all.split, by=\"SearchID\", all.x=T)\ndata.all[, SearchType := as.character(SearchType)]\ndata.all[is.na(SearchType), SearchType := \"0\"]\ndata.all[SearchType==\"hist\", SearchType := \"0\"]\ndata.all[SearchType==\"test\", SearchType := \"3\"]\ndata.all[SearchType==\"val\", SearchType := \"2\"]\ndata.all[SearchType==\"tr\", SearchType := \"1\"]\ndata.all[, SearchType := as.numeric(SearchType)]\ndata.all[is.na(IsClick), IsClick := 0]\nrm(data.all.split)\ngc()\n\ndata.search.feat <- data.all[,list(SearchObjectType3Count = sum(ObjectType==3),\n                                   SearchObjectType2Count = sum(ObjectType==2),\n                                   SearchObjectType1Count = sum(ObjectType==1),\n                                   #SearchObjectType12Count = sum(ObjectType!=3),\n                                   #SearchAdCount = .N,\n                                   SearchPosition1Count = sum(Position==1),\n                                   SearchPosition2Count = sum(Position==2),\n                                   SearchPosition6Count = sum(Position==6),\n                                   SearchPosition7Count = sum(Position==7),\n                                   SearchPosition8Count = sum(Position==8),\n                                   SearchAdUniqueCount = length(unique(AdID))),by=\"SearchID\"]\ndata.ad.feat <- data.all[, list(#AdObjectTypeUniqueCount = length(unique(ObjectType)),\n                                AdPosition1Count = sum(Position==1),\n                                #AdPosition2Count = sum(Position==2),\n                                #AdPosition6Count = sum(Position==6),\n                                AdPosition7Count = sum(Position==7)), by=\"AdID\"]\n                                #AdPosition8Count = sum(Position==8)), by=\"AdID\"]\n\n#AdPosition12Count = sum(Position==1 | Position==2),\n#AdPosition678Count = sum(Position>2)\ndata.all <- data.all[ObjectType==3]\ngc()\ndata.all[, ObjectType := NULL]\nsetkey(data.all, SearchID)\nsetkey(data.search.feat, SearchID)\ndata.all <- merge(data.all, data.search.feat, by=\"SearchID\", all.x=T)\nrm(data.search.feat)\ngc()\n\nsetkey(data.all, AdID)\nsetkey(data.ad.feat, AdID)\ndata.all <- merge(data.all, data.ad.feat, by=\"AdID\", all.x=T)\nrm(data.ad.feat)\ngc()\n\n### save dataset ###\nsetkey(data.all, ID)\n\n### first set of features ###\nflist.basic <- c(\"ID\", \"SearchID\", \"AdID\", \"Position\", \"HistCTR\", \"SearchType\", \"IsClick\")\nflist1 <- setdiff(colnames(data.all), flist.basic)\ndata.feats1 <- data.all[, flist1, with=F]\nsave(data.feats1, file=fn.rdata.file(\"data.feats1.RData\"))\nrm(data.feats1)\ngc()\n\n### basic set of features ###\ndata.id <- data.all[,flist.basic,with=F]\nrm(data.all)\ngc()\nsave(data.id, file=fn.rdata.file(\"data.id.RData\"))\n\n### generate search features ###\ndata.search.info <- fread(fn.in.file(search.info.file))\nsetnames(data.search.info, \"LocationID\", \"SearchLocationID\")\nsetnames(data.search.info, \"CategoryID\", \"SearchCategoryID\")\ndata.search.info[, SearchDayYear := as.numeric(format(as.Date(SearchDate, format=\"%Y-%m-%d\"), format = \"%j\"))]\n#data.search.info[, SearchWeekYear := as.numeric(format(as.Date(SearchDate, format=\"%Y-%m-%d\"), format = \"%V\"))]\n#data.search.info[, SearchWeekday := as.numeric(format(as.Date(SearchDate, format=\"%Y-%m-%d\"), format = \"%w\"))]\n#data.search.info[SearchWeekday==0, SearchWeekday := 7]\ndata.search.info[, SearchDate := NULL]\ndata.search.info[, SearchQuerySize := nchar(SearchQuery)]\nrussian.alphabet <- c(\"а|б|в|г|д|е|ж|з|и|й|к|л|м|н|о|п|р|с|т|у|ф|х|ц|ч|ш|щ|ъ|ы|ь|э|ю|я\")\ndata.search.info[, SearchRussian := as.numeric(grepl(russian.alphabet, SearchQuery))]\ndata.search.info[, SearchQuery := NULL]\ndata.search.info[, SearchParamsSize := nchar(SearchParams)]\ndata.search.info[, SearchParams2 := gsub(\":\",\"\",SearchParams)]\ndata.search.info[, SearchParamsCount := SearchParamsSize - nchar(SearchParams2)]\ndata.search.info[, SearchParams := NULL]\ndata.search.info[, SearchParams2 := NULL]\ngc()\n\ndata.search.feats <- data.search.info[,list(UserSearchUniqueCount = length(unique(SearchID)),\n                                            UserSearchLocationUniqueCount = length(unique(SearchLocationID)),\n                                            UserSearchCategoryUniqueCount = length(unique(SearchCategoryID))),by=\"UserID\"]\n                                            #UserIPUniqueCount = length(unique(IPID))),by=\"UserID\"]\nsetkey(data.search.feats, UserID)\nsetkey(data.search.info, UserID)\ndata.feats2 <- merge(data.search.info, data.search.feats, by=\"UserID\", all.x=T)\ngc()\n\ndata.search.feats <- data.search.info[,list(LocationUserUniqueCount = length(unique(UserID))),by=\"SearchLocationID\"]\nsetkey(data.search.feats, SearchLocationID)\nsetkey(data.feats2, SearchLocationID)\ndata.feats2 <- merge(data.feats2, data.search.feats, by=\"SearchLocationID\", all.x=T)\n\ndata.search.feats <- data.search.info[,list(CategoryUserUniqueCount = length(unique(UserID))),by=\"SearchCategoryID\"]\nsetkey(data.search.feats, SearchCategoryID)\nsetkey(data.feats2, SearchCategoryID)\ndata.feats2 <- merge(data.feats2, data.search.feats, by=\"SearchCategoryID\", all.x=T)\nrm(data.search.feats)\ngc()\n\ndata.search.feats <- data.search.info[,list(UserID, SearchDayYear)]\ndata.search.feats <- data.search.feats[,list(Count = .N), by=c(\"UserID\", \"SearchDayYear\")]\nfor (days.before in c(1:7)) {\n  data.search.feats2 <- data.search.feats[,list(UserID, SearchDayYear, Count)]\n  data.search.feats2[, SearchDayYear := SearchDayYear+days.before]\n  setnames(data.search.feats2, \"Count\", \"CountPrevious\")\n  setkey(data.search.feats, UserID, SearchDayYear)\n  setkey(data.search.feats2, UserID, SearchDayYear)\n  data.search.feats <- merge(data.search.feats, data.search.feats2, by=c(\"UserID\", \"SearchDayYear\"), all.x=T)\n  data.search.feats[is.na(CountPrevious), CountPrevious := 0]\n  setnames(data.search.feats, \"CountPrevious\", paste0(\"CountPrevious\",days.before))\n}\nrm(data.search.feats2)\ndata.search.feats[, UserSearchCount3 := Count + CountPrevious1 + CountPrevious2]\ndata.search.feats[, UserSearchCount7 := Count + CountPrevious1 + CountPrevious2 + CountPrevious3 + CountPrevious4 + CountPrevious5 + CountPrevious6 + CountPrevious7]\ndata.search.feats <- data.search.feats[,list(UserID,\n                                             SearchDayYear,\n                                             UserSearchCount3,\n                                             UserSearchCount7)]\nsetkey(data.search.feats, UserID, SearchDayYear)\nsetkey(data.feats2, UserID, SearchDayYear)\ndata.feats2 <- merge(data.feats2, data.search.feats, by=c(\"UserID\",\"SearchDayYear\"), all.x=T)\nrm(data.search.feats)\ngc()\n\nsetkey(data.search.info, UserID, SearchDayYear, SearchID)\ndata.search.feats <- data.search.info[,list(SearchID = SearchID[2:(.N)],\n                                            SearchIDPreviousAge = SearchDayYear[2:(.N)] - SearchDayYear[1:(.N-1)]),by=\"UserID\"]\ndata.search.feats <- data.search.feats[!is.na(SearchIDPreviousAge)]\nsetkey(data.search.feats, UserID, SearchID)\nsetkey(data.feats2, UserID, SearchID)\ndata.feats2 <- merge(data.feats2, data.search.feats, by=c(\"UserID\",\"SearchID\"), all.x=T)\nrm(data.search.feats)\ngc()\ndata.feats2[is.na(SearchIDPreviousAge), SearchIDPreviousAge := -1]\nrm(data.search.info)\ngc()\nload(fn.rdata.file(\"data.id.RData\"))\nsetkey(data.id, SearchID)\nsetkey(data.feats2, SearchID)\ndata.feats2 <- merge(data.id, data.feats2, by=c(\"SearchID\"), all.x=T)\nsetkey(data.feats2, ID)\nflist.basic <- c(\"ID\", \"SearchID\", \"SearchLocationID\", \"SearchCategoryID\", \"SearchDayYear\", \"AdID\", \"UserID\", \"Position\", \"HistCTR\", \"SearchType\", \"IsClick\")\nflist2 <- setdiff(colnames(data.feats2), flist.basic)\ndata.id <- data.feats2[,flist.basic,with=F]\nsave(data.id, file=fn.rdata.file(\"data.id.RData\"))\nrm(data.id)\ngc()\ndata.feats2 <- data.feats2[, flist2, with=F]\nsave(data.feats2, file=fn.rdata.file(\"data.feats2.RData\"))\nrm(data.feats2)\ngc()\n\ndata.ads.info <- fread(fn.in.file(ads.info.file))\ndata.ads.info[, LocationID := NULL]\nsetnames(data.ads.info, \"CategoryID\", \"AdCategoryID\")\nsetnames(data.ads.info, \"Params\", \"AdParams\")\nsetnames(data.ads.info, \"Title\", \"AdTitle\")\ndata.ads.info[, AdParamsSize := nchar(AdParams)]\ndata.ads.info[, AdParams2 := gsub(\":\",\"\",AdParams)]\ndata.ads.info[, AdParamsCount := AdParamsSize - nchar(AdParams2)]\ndata.ads.info[,AdParams := NULL]\ndata.ads.info[,AdParams2 := NULL]\ndata.ads.info[, AdTitleSize := nchar(AdTitle)]\ndata.ads.info[, AdTitle := NULL]\ndata.ads.info[, IsContext := NULL]\nload(fn.rdata.file(\"data.id.RData\"))\nsetkey(data.id, AdID)\nsetkey(data.ads.info, AdID)\ndata.feats3 <- merge(data.id, data.ads.info, by=c(\"AdID\"), all.x=T)\n\ndata.feats <- data.feats3[,list(AdSearchUniqueCount = length(unique(SearchID))),by=\"AdID\"]\nsetkey(data.feats3, AdID)\nsetkey(data.feats, AdID)\ndata.feats3 <- merge(data.feats3, data.feats, by=\"AdID\", all.x=T)\n\ndata.feats <- data.feats3[,list(UserAdUniqueCount = length(unique(AdID))),by=\"UserID\"]\nsetkey(data.feats3, UserID)\nsetkey(data.feats, UserID)\ndata.feats3 <- merge(data.feats3, data.feats, by=\"UserID\", all.x=T)\n\ndata.feats <- data.feats3[,list(UserAdCount = .N), by=c(\"UserID\", \"AdID\")]\nsetkey(data.feats3, UserID, AdID)\nsetkey(data.feats, UserID, AdID)\ndata.feats3 <- merge(data.feats3, data.feats, by=c(\"UserID\",\"AdID\"), all.x=T)\n\ndata.feats3[is.na(AdCategoryID), AdCategoryID := -1]\ndata.feats <- data.feats3[,list(AdCategoryPriceMedian = median(Price)), by=c(\"AdCategoryID\")]\nsetkey(data.feats3, AdCategoryID)\nsetkey(data.feats, AdCategoryID)\ndata.feats3 <- merge(data.feats3, data.feats, by=c(\"AdCategoryID\"), all.x=T)\ndata.feats3[, AdCategoryPriceDeviation := round((Price - AdCategoryPriceMedian)/AdCategoryPriceMedian, 6)]\ndata.feats3[is.na(Price), Price := 0]\ndata.feats3[is.na(AdCategoryPriceDeviation), AdCategoryPriceDeviation := 0]\ndata.feats3[, AdCategoryPriceMedian := NULL]\nrm(data.feats, data.ads.info)\ngc()\n\nsetkey(data.feats3, ID)\nflist.basic <- c(\"ID\", \"SearchID\", \"SearchLocationID\", \"SearchCategoryID\", \"SearchDayYear\", \"AdID\", \"AdCategoryID\", \"UserID\", \"Position\", \"HistCTR\", \"SearchType\", \"IsClick\")\nflist3 <- setdiff(colnames(data.feats3), flist.basic)\ndata.id <- data.feats3[,flist.basic,with=F]\nsave(data.id, file=fn.rdata.file(\"data.id.RData\"))\nrm(data.id)\ndata.feats3 <- data.feats3[, flist3, with=F]\nsave(data.feats3, file=fn.rdata.file(\"data.feats3.RData\"))\nrm(data.feats3)\ngc()\n\n### user info file ###\ndata.user.info <- fread(fn.in.file(user.info.file))\nload(fn.rdata.file(\"data.id.RData\"))\nsetkey(data.id, UserID)\nsetkey(data.user.info, UserID)\ndata.feats4 <- merge(data.id, data.user.info, by=c(\"UserID\"), all.x=T)\nsetkey(data.feats4, ID)\nflist.basic <- c(\"ID\", \"SearchID\", \"SearchLocationID\", \"SearchCategoryID\", \"SearchDayYear\", \"AdID\", \"AdCategoryID\", \"UserID\", \"Position\", \"HistCTR\", \"SearchType\", \"IsClick\")\nflist4 <- setdiff(colnames(data.feats4), flist.basic)\ndata.feats4 <- data.feats4[, flist4, with=F]\nsave(data.feats4, file=fn.rdata.file(\"data.feats4.RData\"))\nrm(data.feats4, data.user.info)\ngc()\n\n### category and location features ###\ndata.category <- fread(fn.in.file(category.file))\nsetnames(data.category, \"CategoryID\", \"SearchCategoryID\")\nsetnames(data.category, \"Level\", \"CategoryLevel\")\ndata.location <- fread(fn.in.file(location.file))\nsetnames(data.location, \"LocationID\", \"SearchLocationID\")\nsetnames(data.location, \"Level\", \"LocationLevel\")\nload(fn.rdata.file(\"data.id.RData\"))\nsetkey(data.id, SearchCategoryID)\nsetkey(data.category, SearchCategoryID)\ndata.feats5 <- merge(data.id, data.category, by=c(\"SearchCategoryID\"), all.x=T)\nsetkey(data.feats5, SearchLocationID)\nsetkey(data.location, SearchLocationID)\ndata.feats5 <- merge(data.feats5, data.location, by=c(\"SearchLocationID\"), all.x=T)\nsetkey(data.feats5, ID)\nflist.basic <- c(\"ID\", \"SearchID\", \"SearchLocationID\", \"SearchCategoryID\", \"SearchDayYear\", \"AdID\", \"AdCategoryID\", \"UserID\", \"Position\", \"HistCTR\", \"SearchType\", \"IsClick\")\nflist5 <- setdiff(colnames(data.feats5), flist.basic)\ndata.feats5 <- data.feats5[, flist5, with=F]\nsave(data.feats5, file=fn.rdata.file(\"data.feats5.RData\"))\nrm(data.feats5, data.category, data.location)\ngc()\n\n### visits stream ###\ndata.visits.stream <- fread(fn.in.file(visits.stream.file))\ndata.visits.stream[, ViewDayYear := as.numeric(format(as.Date(ViewDate, format=\"%Y-%m-%d\"), format = \"%j\"))]\ndata.visits.stream[, ViewDate := NULL]\ngc()\ndata.ads.info <- fread(fn.in.file(ads.info.file))\nsetnames(data.ads.info, \"CategoryID\", \"AdCategoryID\")\ndata.ads.info <- data.ads.info[,list(AdID, AdCategoryID, Price)]\ngc()\nsetkey(data.ads.info, AdID)\nsetkey(data.visits.stream, AdID)\ndata.visits.stream <- merge(data.visits.stream, data.ads.info, by=\"AdID\", all.x=T)\nload(fn.rdata.file(\"data.id.RData\"))\n\ndata.feats <- data.visits.stream[,list(UserAdViewTotalCount = .N,\n                                       UserAdViewUniqueCount = length(unique(AdID))),by=\"UserID\"]\nsetkey(data.id, UserID)\nsetkey(data.feats, UserID)\ndata.feats6 <- merge(data.id, data.feats, \"UserID\", all.x=T)\nrm(data.id, data.feats)\ngc()\n\ndata.feats <- data.visits.stream[,list(UserAdCategoryPriceMean = round(mean(Price), 6),\n                                       UserAdCategoryPriceMedian = median(Price),\n                                       UserAdCategoryPriceMin = min(Price),\n                                       UserAdCategoryPriceMax = max(Price)),by=c(\"UserID\",\"AdCategoryID\")]\nsetkey(data.feats6, UserID, AdCategoryID)\nsetkey(data.feats, UserID, AdCategoryID)\ndata.feats6 <- merge(data.feats6, data.feats, c(\"UserID\", \"AdCategoryID\"), all.x=T)\n\nrm(data.feats, data.visits.stream, data.ads.info)\ngc()\n\nsetkey(data.feats6, ID)\nflist.basic <- c(\"ID\", \"SearchID\", \"SearchLocationID\", \"SearchCategoryID\", \"SearchDayYear\", \"AdID\", \"AdCategoryID\", \"UserID\", \"Position\", \"HistCTR\", \"SearchType\", \"IsClick\")\nflist6 <- setdiff(colnames(data.feats6), flist.basic)\ndata.feats6 <- data.feats6[, flist6, with=F]\nfor (col in colnames(data.feats6)) {\n  setnames(data.feats6, col, \"feature\")\n  data.feats6[is.na(feature), feature := -1]\n  setnames(data.feats6, \"feature\", col)\n}\nsave(data.feats6, file=fn.rdata.file(\"data.feats6.RData\"))\nrm(data.feats6)\ngc()\n\n### phone requests stream ###\ndata.phone.requests.stream <- fread(fn.in.file(phone.requests.stream.file))\ndata.phone.requests.stream[, PhoneRequestDayYear := as.numeric(format(as.Date(PhoneRequestDate, format=\"%Y-%m-%d\"), format = \"%j\"))]\ndata.phone.requests.stream[, PhoneRequestDate := NULL]\ngc()\ndata.ads.info <- fread(fn.in.file(ads.info.file))\nsetnames(data.ads.info, \"CategoryID\", \"AdCategoryID\")\ndata.ads.info <- data.ads.info[,list(AdID, AdCategoryID, Price)]\ngc()\nsetkey(data.ads.info, AdID)\nsetkey(data.phone.requests.stream, AdID)\ndata.phone.requests.stream <- merge(data.phone.requests.stream, data.ads.info, by=\"AdID\", all.x=T)\nload(fn.rdata.file(\"data.id.RData\"))\n\ndata.feats <- data.phone.requests.stream[,list(UserAdViewTotalCount2 = .N,\n                                               UserAdViewUniqueCount2 = length(unique(AdID))),by=\"UserID\"]\nsetkey(data.id, UserID)\nsetkey(data.feats, UserID)\ndata.feats7 <- merge(data.id, data.feats, \"UserID\", all.x=T)\nrm(data.id, data.feats)\ngc()\n\ndata.feats <- data.phone.requests.stream[,list(UserAdCategoryPriceMean2 = round(mean(Price), 6),\n                                               UserAdCategoryPriceMedian2 = median(Price),\n                                               UserAdCategoryPriceMin2 = min(Price),\n                                               UserAdCategoryPriceMax2 = max(Price)),by=c(\"UserID\",\"AdCategoryID\")]\nsetkey(data.feats7, UserID, AdCategoryID)\nsetkey(data.feats, UserID, AdCategoryID)\ndata.feats7 <- merge(data.feats7, data.feats, c(\"UserID\", \"AdCategoryID\"), all.x=T)\n\nrm(data.feats, data.phone.requests.stream, data.ads.info)\ngc()\n\nsetkey(data.feats7, ID)\nflist.basic <- c(\"ID\", \"SearchID\", \"SearchLocationID\", \"SearchCategoryID\", \"SearchDayYear\", \"AdID\", \"AdCategoryID\", \"UserID\", \"Position\", \"HistCTR\", \"SearchType\", \"IsClick\")\nflist7 <- setdiff(colnames(data.feats7), flist.basic)\ndata.feats7 <- data.feats7[, flist7, with=F]\nfor (col in colnames(data.feats7)) {\n  setnames(data.feats7, col, \"feature\")\n  data.feats7[is.na(feature), feature := -1]\n  setnames(data.feats7, \"feature\", col)\n}\nsave(data.feats7, file=fn.rdata.file(\"data.feats7.RData\"))\nrm(data.feats7)\ngc()\n\n#############################################################################\n################ MAKE DATASET AND LIKELIHOOD FEATURES #######################\n#############################################################################\n\nspar <- 30\n\nload(fn.rdata.file(\"data.id.RData\"))\nis.click <- data.id[,IsClick]\nids <- data.id[,ID]\nsearch.type <- data.id[,SearchType]\nglobal.avg <- round(mean(data.id[SearchType<3][,IsClick]), 5)\ndata.reduced <- data.id[SearchType>0][,list(ID,\n                                            IsClick,\n                                            SearchType,\n                                            SearchDayYear,\n                                            Position,\n                                            HistCTR,\n                                            AdID,\n                                            UserID,\n                                            SearchLocationID,\n                                            SearchCategoryID,\n                                            AdCategoryID)]\n\nfeats <- c(\"AdID\",\n           \"UserID\",\n           \"SearchLocationID\",\n           \"SearchCategoryID\",\n           \"AdCategoryID\")\nfor (feat in feats) {\n  cat(\"Processing feature\", feat, \"...\\n\")\n  data.likeli.list <- list()\n  for (st in c(0:2)) {\n    data.likeli <- data.id[SearchType<=st][,list(likeli = round((sum(IsClick) + spar*global.avg)/(.N+spar), 5),\n                                                 SearchType = st+1),by=feat]\n    data.likeli.list[[length(data.likeli.list)+1]] <- data.likeli\n  }\n  rm(data.likeli)\n  invisible(gc())\n  data.likeli.list <- rbindlist(data.likeli.list, use.names=T, fill=F)\n  setkeyv(data.likeli.list, c(\"SearchType\",feat))\n  setkeyv(data.reduced, c(\"SearchType\",feat))\n  data.reduced <- merge(data.reduced, data.likeli.list, by=c(\"SearchType\", feat), all.x=T)\n  data.reduced[is.na(likeli), likeli := global.avg]\n  setnames(data.reduced, \"likeli\", paste0(feat,\"likeli\"))\n  data.reduced[, feat := NULL, with=F]\n  rm(data.likeli.list)\n  invisible(gc())\n}\nrm(data.id)\ngc()\ndata.reduced.all <- copy(data.reduced)\nsetkey(data.reduced.all, ID)\n\n##### data.feats1 ######\nload(fn.rdata.file(\"data.feats1.RData\"))\ndata.feats1[, ID := ids]\ndata.feats1[, SearchType := search.type]\ndata.reduced <- data.feats1[SearchType>0]\ndata.reduced[,SearchType := NULL]\nsetkey(data.reduced, ID)\nflist <- setdiff(colnames(data.reduced),\n                 c(\"SearchObjectType2Count\",\n                   \"SearchPosition1Count\",\n                   \"SearchPosition8Count\",\n                   \"SearchAdUniqueCount\"))\ndata.reduced.all <- merge(data.reduced.all, data.reduced[,flist,with=F], by=\"ID\", all.x=T)\nrm(data.feats1)\ngc()\n\n##### data.feats2 ######\nload(fn.rdata.file(\"data.feats2.RData\"))\ndata.feats2[, ID := ids]\ndata.feats2[, SearchType := search.type]\ndata.feats2[, IsClick := is.click]\ndata.reduced <- data.feats2[SearchType>0]\ndata.reduced[,SearchType := NULL]\ndata.reduced[,IsClick := NULL]\nsetkey(data.reduced, ID)\nflist <- setdiff(colnames(data.reduced),\n                 c(\"UserSearchLocationUniqueCount\",\n                   \"UserSearchCategoryUniqueCount\",\n                   \"UserSearchCount7\",\n                   \"UserSearchCount3\",\n                   \"IPID\"))\ndata.reduced.all <- merge(data.reduced.all, data.reduced[,flist,with=F], by=\"ID\", all.x=T)\n\n##### data.feats3 ######\nload(fn.rdata.file(\"data.feats3.RData\"))\ndata.feats3[, ID := ids]\ndata.feats3[, SearchType := search.type]\ndata.reduced <- data.feats3[SearchType>0]\ndata.reduced[,SearchType := NULL]\nsetkey(data.reduced, ID)\nflist <- setdiff(colnames(data.reduced),\n                 c(\"AdSearchUniqueCount\",\n                   \"UserAdUniqueCount\"))\ndata.reduced.all <- merge(data.reduced.all, data.reduced[,flist,with=F], by=\"ID\", all.x=T)\nrm(data.feats3)\ngc()\n\n##### data.feats4 ######\nload(fn.rdata.file(\"data.feats4.RData\"))\ndata.feats4[, ID := ids]\ndata.feats4[, SearchType := search.type]\ndata.feats4[, IsClick := is.click]\ndata.reduced <- data.feats4[SearchType>0]\nfeats <- c(\"UserAgentID\",\n           \"UserAgentOSID\",\n           \"UserDeviceID\",\n           \"UserAgentFamilyID\")\nfor (feat in feats) {\n  cat(\"Processing feature\", feat, \"...\\n\")\n  data.likeli.list <- list()\n  for (st in c(0:2)) {\n    data.likeli <- data.feats4[SearchType<=st][,list(likeli = round((sum(IsClick) + spar*global.avg)/(.N+spar), 5),\n                                                     SearchType = st+1),by=feat]\n    data.likeli.list[[length(data.likeli.list)+1]] <- data.likeli\n  }\n  rm(data.likeli)\n  invisible(gc())\n  data.likeli.list <- rbindlist(data.likeli.list, use.names=T, fill=F)\n  setkeyv(data.likeli.list, c(\"SearchType\",feat))\n  setkeyv(data.reduced, c(\"SearchType\",feat))\n  data.reduced <- merge(data.reduced, data.likeli.list, by=c(\"SearchType\", feat), all.x=T)\n  data.reduced[is.na(likeli), likeli := global.avg]\n  setnames(data.reduced, \"likeli\", paste0(feat,\"likeli\"))\n  data.reduced[, feat := NULL, with=F]\n  rm(data.likeli.list)\n  invisible(gc())\n}\nrm(data.feats4)\ngc()\ndata.reduced[,SearchType := NULL]\ndata.reduced[,IsClick := NULL]\nsetkey(data.reduced, ID)\ndata.reduced.all <- merge(data.reduced.all, data.reduced, by=\"ID\", all.x=T)\n\n##### data.feats6 ######\nload(fn.rdata.file(\"data.feats6.RData\"))\ndata.feats6[, ID := ids]\ndata.feats6[, SearchType := search.type]\ndata.reduced <- data.feats6[SearchType>0]\ndata.reduced[,SearchType := NULL]\nsetkey(data.reduced, ID)\ndata.reduced.all <- merge(data.reduced.all, data.reduced, by=\"ID\", all.x=T)\nrm(data.feats6)\ngc()\n\n##### data.feats7 ######\nload(fn.rdata.file(\"data.feats7.RData\"))\ndata.feats7[, ID := ids]\ndata.feats7[, SearchType := search.type]\ndata.reduced <- data.feats7[SearchType>0]\ndata.reduced[,SearchType := NULL]\nsetkey(data.reduced, ID)\ndata.reduced.all <- merge(data.reduced.all, data.reduced, by=\"ID\", all.x=T)\nrm(data.feats7)\ngc()\n\nrm(ids, is.click, search.type)\ngc()\n\n#### add 2-way likelihood #####\nload(fn.rdata.file(\"data.id.RData\"))\ndata.feats <- data.id[,list(ID,\n                            SearchType,\n                            IsClick,\n                            UserID,\n                            AdID,\n                            SearchLocationID,\n                            SearchCategoryID,\n                            AdCategoryID)]\nrm(data.id)\ninvisible(gc())\nload(fn.rdata.file(\"data.feats2.RData\"))\ndata.feats[, IPID := data.feats2$IPID]\nrm(data.feats2)\ninvisible(gc())\nload(fn.rdata.file(\"data.feats4.RData\"))\ndata.feats[, UserAgentOSID := data.feats4$UserAgentOSID]\ndata.feats[, UserAgentFamilyID := data.feats4$UserAgentFamilyID]\nrm(data.feats4)\ninvisible(gc())\ndata.reduced <- data.feats[SearchType>0]\nflist <- setdiff(colnames(data.feats), c(\"ID\", \"SearchType\", \"IsClick\"))\nfor (i in 1:(length(flist)-1)) {\n  for (j in (i+1):length(flist)) {\n    f1 <- flist[i]\n    f2 <- flist[j]\n    cat(\"Processing features\", f1, f2, \"...\\n\")\n    data.group <- data.feats[,list(group = .GRP), by=c(f1, f2)]\n    setkeyv(data.group, c(f1,f2))\n    setkeyv(data.feats, c(f1,f2))\n    setkeyv(data.reduced, c(f1,f2))\n    data.feats <- merge(data.feats, data.group, by=c(f1, f2), all.x=T)\n    data.reduced <- merge(data.reduced, data.group, by=c(f1, f2), all.x=T)\n    data.likeli.list <- list()\n    for (st in c(0:2)) {\n      data.likeli <- data.feats[SearchType<=st][,list(likeli = round((sum(IsClick) + spar*global.avg)/(.N+spar), 5),\n                                                      SearchType = st+1),by=\"group\"]\n      data.likeli.list[[length(data.likeli.list)+1]] <- data.likeli\n    }\n    rm(data.likeli)\n    invisible(gc())\n    data.likeli.list <- rbindlist(data.likeli.list, use.names=T, fill=F)\n    setkeyv(data.likeli.list, c(\"SearchType\",\"group\"))\n    setkeyv(data.reduced, c(\"SearchType\",\"group\"))\n    data.reduced <- merge(data.reduced, data.likeli.list, by=c(\"SearchType\", \"group\"), all.x=T)\n    data.reduced[is.na(likeli), likeli := global.avg]\n    setnames(data.reduced, \"likeli\", paste0(f1,f2,\"likeli\"))\n    data.reduced[, group := NULL]\n    data.feats[, group := NULL]\n    rm(data.likeli.list)\n    invisible(gc())\n  }\n}\nrm(data.feats, data.group)\nfor (f in flist) {\n  data.reduced[, f := NULL, with=F]\n}\ndata.reduced[,SearchType := NULL]\ndata.reduced[,IsClick := NULL]\nsetkey(data.reduced, ID)\ndata.reduced.all <- merge(data.reduced.all, data.reduced, by=\"ID\", all.x=T)\ngc()\n\nrm(data.reduced)\ngc()\nsave(data.reduced.all, file=fn.rdata.file(\"data.reduced.all.RData\"))\nrm(data.reduced.all)\ngc()\n\n#############################################################################\n########################### ADD TEXT FEATURES ###############################\n#############################################################################\n\ndata.ads.info <- fread(fn.in.file(ads.info.file))\nsetnames(data.ads.info, \"Title\", \"AdTitle\")\ndata.ads.info <- data.ads.info[,list(AdID, AdTitle)]\ndata.ads.info[, AdTitleSize := nchar(AdTitle)]\ndata.ads.info <- data.ads.info[AdTitleSize>0]\ndata.ads.info[, AdTitleSize := NULL]\ngc()\n\ndata.ads.info[, AdTitle := removePunctuation(AdTitle)]\ndata.ads.info[, AdTitle := stripWhitespace(AdTitle)]\ndata.ads.info[, AdTitle := tolower(AdTitle)]\n\ndata.ads.info <- data.ads.info[, list(AdTitleWord = unlist(strsplit(AdTitle, \" \"))), by=\"AdID\"]\ndata.ads.info[, AdTitleWordSize := nchar(AdTitleWord)]\ndata.ads.info <- data.ads.info[AdTitleWordSize>2]\ndata.ads.info[, AdTitleWordSize := NULL]\ngc()\n\ndata.search.info <- fread(fn.in.file(search.info.file))\ndata.search.info <- data.search.info[,list(SearchID, SearchQuery)]\ngc()\ndata.search.info[, SearchQuerySize := nchar(SearchQuery)]\ndata.search.info <- data.search.info[SearchQuerySize>0]\ndata.search.info[, SearchQuerySize := NULL]\n\ndata.search.info[, SearchQuery := removePunctuation(SearchQuery)]\ndata.search.info[, SearchQuery := stripWhitespace(SearchQuery)]\ndata.search.info[, SearchQuery := tolower(SearchQuery)]\ndata.search.info <- data.search.info[, list(SearchQueryWord = unlist(strsplit(SearchQuery, \" \"))), by=\"SearchID\"]\ndata.search.info[, SearchQueryWordSize := nchar(SearchQueryWord)]\ndata.search.info <- data.search.info[SearchQueryWordSize>2]\ndata.search.info[, SearchQueryWordSize := NULL]\ngc()\n\nload(fn.rdata.file(\"data.id.RData\"))\ndata.click <- data.id[SearchType>0][,list(SearchID,AdID)]\nrm(data.id)\ngc()\ndata.click <- merge(data.click, data.ads.info, all.x=T, allow.cartesian=T, by=\"AdID\")\ndata.click <- merge(data.click, data.search.info, all.x=T, allow.cartesian=T, by=\"SearchID\")\ndata.click <- data.click[!is.na(SearchQueryWord)]\ndata.click <- data.click[,list(SearchAdCommonWordCount = sum(AdTitleWord==SearchQueryWord)),by=c(\"SearchID\", \"AdID\")]\n\nload(fn.rdata.file(\"data.id.RData\"))\nsetkey(data.id, ID)\nload(fn.rdata.file(\"data.reduced.all.RData\"))\nsetkey(data.reduced.all, ID)\ndata.reduced.all <- merge(data.reduced.all, data.id[,list(ID, \n                                                          AdID,\n                                                          SearchID)], by=\"ID\", all.x=T)\nrm(data.id)\ngc()\nsetkey(data.reduced.all, AdID, SearchID)\nsetkey(data.click, AdID, SearchID)\ndata.reduced.all <- merge(data.reduced.all, data.click, by=c(\"AdID\", \"SearchID\"), all.x=T)\ndata.reduced.all[is.na(SearchAdCommonWordCount), SearchAdCommonWordCount := 0]\ndata.reduced.all[,AdID := NULL]\ndata.reduced.all[,SearchID := NULL]\nsetkey(data.reduced.all, ID)\nsave(data.reduced.all, file=fn.rdata.file(\"data.reduced.all.RData\"))\ngc()\n",
    "created" : 1439667463478.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2100390234",
    "id" : "9AC31F31",
    "lastKnownWriteTime" : 1439585632,
    "path" : "~/Documents/eclipse/AvitoContext2015/final_model/avito-context-click-r/data.build.dtry.R",
    "project_path" : "data.build.dtry.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}